@using ERS_Management.Models.Enums
@model IEnumerable<ERS_Management.Models.Entries>

@{
    ViewData["Title"] = "Inventory";
    var entries = Model.ToList();

    // Extract unique filter options
    var areas = entries.Select(e => e.Area).Where(a => a != null).Distinct().OrderBy(a => a).ToList();
    var locations = entries.Select(e => e.Location).Where(l => l != null).Distinct().OrderBy(l => l).ToList();
    var brands = entries.Select(e => e.Brand).Where(b => b != null).Distinct().OrderBy(b => b).ToList();
    var itemTypes = entries.Select(e => e.ItemType).Where(it => it != null).Distinct().OrderBy(it => it).ToList();
    var status = entries.Select(e => e.Status).Where(it => it != null).Distinct().OrderBy(it => it).ToList();

    const int PageSize = 10; // Items per page
}

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root { --bs-border-radius: .5rem; }
        .card { border: 0; box-shadow: 0 2px 8px rgba(0,0,0,.08); }
        .glass { background: rgba(255,255,255,.15); backdrop-filter: blur(10px); }
        .table-sm th, .table-sm td { padding: .5rem .75rem; font-size: .875rem; }
        .badge { font-size: .7rem; padding: .35em .6em; }
        .btn-sm { font-size: .775rem; }
        .filter-row th { background: #f8f9fa; }
    </style>
}

<div class="container-fluid py-3">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="h5 mb-0 fw-bold">Inventory Entries</h3>
        <div class="d-flex gap-1">
            <button id="exportBtn" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#exportModal">
                Export
            </button>
            <a asp-action="Create" class="btn btn-primary btn-sm">Create New</a>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="card rounded-3 mb-3">
        <div class="card-body p-3">
            <div class="row g-2 align-items-center">
                <!-- Global Search -->
                <div class="col-12 col-md-5">
                    <div class="position-relative">
                        <div class="input-group input-group-sm glass rounded-3">
                            <span class="input-group-text border-0 text-primary">
                                <i class="bi bi-search"></i>
                            </span>
                            <input id="globalSearch" class="form-control bg-body-secondary bg-opacity-25 border-0" 
                                   placeholder="Search..." autocomplete="off">
                        </div>
                        <button id="clearSearch" class="btn btn-sm position-absolute end-0 top-50 translate-middle-y me-2 d-none">
                            <i class="bi bi-x-circle-fill text-muted"></i>
                        </button>
                    </div>
                </div>

                <!-- Date Range -->
                <div class="d-flex col-6 col-md-3">
                    <label class="m-2">From:</label>
                    <input id="fromDate" type="date" class="form-control form-control-sm rounded-3">
                </div>
                <div class="d-flex col-6 col-md-3">
                    <label class="m-2">To:</label>
                    <input id="toDate" type="date" class="form-control form-control-sm rounded-3">
                </div>

                <!-- Clear Filters -->
                <div class="col-12 col-md-1 text-end">
                    <button onclick="clearFilters()" class="btn btn-outline-secondary btn-sm w-100">
                        <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card rounded-3 overflow-hidden">
        <div class="table-responsive">
            <table class="table table-sm table-hover mb-0" id="entriesTable">
                <!-- Main Header -->
                <thead class="table-light small text-uppercase">
                    <tr>
                        <th class="ps-3">SN</th>
                        <th>Area</th>
                        <th>Location</th>
                        <th>Brand</th>
                        <th>Model</th>
                        <th>Type</th>
                        <th>Qty</th>
                        <th>Update</th>
                        <th>Status</th>
                        <th class="text-end pe-3">Actions</th>
                    </tr>
                </thead>

                <!-- Filter Row -->
                <thead class="filter-row">
                    <tr>
                        <th class="ps-3"><input class="form-control form-control-sm" placeholder="SN" data-col="serialNumber"></th>
                        <th>
                            <select class="form-select form-select-sm filter-select" data-col="area">
                                <option value="">All</option>
                                @foreach (var a in areas) { <option>@a</option> }
                            </select>
                        </th>
                        <th>
                            <select class="form-select form-select-sm filter-select" data-col="location">
                                <option value="">All</option>
                                @foreach (var l in locations) { <option>@l</option> }
                            </select>
                        </th>
                        <th>
                            <select class="form-select form-select-sm filter-select" data-col="brand">
                                <option value="">All</option>
                                @foreach (var b in brands) { <option>@b</option> }
                            </select>
                        </th>
                        <th><input class="form-control form-control-sm" placeholder="Model" data-col="model"></th>
                        <th>
                            <select class="form-select form-select-sm filter-select" data-col="itemType">
                                <option value="">All</option>
                                @foreach (var it in itemTypes) { <option>@it</option> }
                            </select>
                        </th>
                        <th><input class="form-control form-control-sm" placeholder="Qty" data-col="quantity"></th>
                        <th></th>
                        <th>
                            <select class="form-select form-select-sm" id="statusFilter">
                                <option value="">All</option>
                                @foreach (var it in status) { <option>@it</option> }
                            </select>
                        </th>
                        <th></th>
                    </tr>
                </thead>

                <!-- Table Body (Populated via JS) -->
                <tbody id="tableBody">
                    <tr><td colspan="10" class="text-center py-3 text-muted">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination & Info -->
        <div class="card-footer bg-white py-2 px-3 d-flex justify-content-between align-items-center small">
            <div>Showing <span id="showRange">0-0</span> of <span id="totalCount">0</span></div>
            <nav>
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item" id="prevBtn"><a class="page-link" href="#">Prev</a></li>
                    <div id="pageNumbers" class="d-flex mx-1"></div>
                    <li class="page-item" id="nextBtn"><a class="page-link" href="#">Next</a></li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Report Title</label>
                    <input type="text" id="reportTitle" class="form-control" value="New Asset List">
                </div>
                <div class="mb-3">
                    <label class="form-label">Select columns for <em>Individual Items</em> sheet</label>
                    <div id="colCheckboxes" class="row"></div>
                </div>
                <div class="alert alert-info">
                    File will be saved as: <strong id="fileName"></strong>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmExport" class="btn btn-primary">Export</button>
            </div>
        </div>
    </div>
</div>







<!-- ==================== LOG MODAL ==================== -->
<div class="modal fade" id="logModal" tabindex="-1" aria-labelledby="logModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content rounded-4 shadow-lg">
            <div class="modal-header bg-gradient-success text-white">
                <h5 class="modal-title" id="logModalLabel">
                    <i class="bi bi-journal-text me-2"></i> Entry Log
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div id="logTimeline" class="p-3"></div>
                <div id="logEmpty" class="text-center text-muted py-4 d-none">
                    <i class="bi bi-inbox fs-1"></i><br>No log entries.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>







@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        const PAGE_SIZE = @PageSize;
        const BDT_OFFSET = 6 * 60; // Bangladesh Time (UTC+6)
        const DEBOUNCE_DELAY = 250; // ms

        // ========================================
        // DOM ELEMENTS CACHE
        // ========================================
        const $ = s => document.querySelector(s);
        const $$ = s => document.querySelectorAll(s);

        const els = {
            body: $('#tableBody'),
            search: $('#globalSearch'),
            clearSearch: $('#clearSearch'),
            fromDate: $('#fromDate'),
            toDate: $('#toDate'),
            statusFilter: $('#statusFilter'),
            filterSelects: $$('.filter-select'),
            filterInputs: $$('.filter-row input[data-col]'),
            prevBtn: $('#prevBtn'),
            nextBtn: $('#nextBtn'),
            pageNumbers: $('#pageNumbers'),
            showRange: $('#showRange'),
            totalCount: $('#totalCount'),
            modal: new bootstrap.Modal('#exportModal'),
            reportTitle: $('#reportTitle'),
            fileName: $('#fileName'),
            confirmExport: $('#confirmExport'),
            colCheckboxes: $('#colCheckboxes')
        };

        // User & Role
        const currentUser = "@User.Identity.Name";
        const isAdmin = @(User.IsInRole("Admin") ? "true" : "false");

        // ========================================
        // DATA PREPARATION
        // ========================================
        const data = @Html.Raw(Json.Serialize(entries.Select(e => new {
            serialNumber = e.SerialNumber,
            area = e.Area ?? "",
            location = e.Location ?? "",
            brand = e.Brand ?? "",
            model = e.Model ?? "",
            itemType = e.ItemType ?? "",
            quantity = e.Quantity,
            lastUpdate = e.LastUpdate?.ToString("o"),
            status = e.Status.ToString(),
            username = e.Username
        })));

        let filteredData = [...data];
        let currentPage = 1;
        let debounceTimer;

        // ========================================
        // HELPER FUNCTIONS
        // ========================================

        // Convert UTC to Bangladesh Time (BDT)
        function toBDT(isoString) {
            if (!isoString) return null;
            const date = new Date(isoString);
            return new Date(date.getTime() + date.getTimezoneOffset() * 60000 + BDT_OFFSET * 60000);
        }

        // Format date to BDT string
        function formatBDT(isoString) {
            const date = toBDT(isoString);
            return date ? date.toLocaleString('en-GB', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            }).replace(',', '') : '';
        }

        // Status badge color
        function getStatusBadge(status) {
            return status === "Running" ? "bg-success" :
                   status === "Damaged" ? "bg-danger" :
                   status === "Standby" ? "bg-warning text-dark" : "bg-secondary";
        }

        // Generate table row HTML
        function createRow(item) {
            return `
<tr>
    <td class="ps-3 fw-medium">#${item.serialNumber}</td>
    <td>${item.area}</td>
    <td>${item.location}</td>
    <td class="text-primary">${item.brand}</td>
    <td>${item.model}</td>
    <td><span class="px-2">${item.itemType}</span></td>
    <td class="text-center">${item.quantity}</td>
    <td><small class="text-muted">BDT</small><br>${formatBDT(item.lastUpdate)}</td>
    <td><span class="badge ${getStatusBadge(item.status)} px-2">${item.status}</span></td>
    <td class="text-end pe-3">
        <div class="btn-group btn-group-sm">
            <a href="/Entries/Details/${item.serialNumber}" class="btn btn-primary">View</a>
          <button type="button" class="btn btn-danger btn-sm" 
        data-bs-toggle="modal" data-bs-target="#logModal"
        data-sn="${item.serialNumber}">
 Logs
</button>
            ${item.username === currentUser ? `<a href="/Entries/Edit/${item.serialNumber}" class="btn btn-secondary">Edit</a>` : ''}
            ${isAdmin ? `<a href="/Entries/Delete/${item.serialNumber}" class="btn btn-danger" onclick="return confirm('Delete?')">Del</a>` : ''}
        </div>
    </td>
</tr>`;
        }

        // ========================================
        // FILTERING LOGIC
        // ========================================
        function applyFilters() {
            const searchTerm = els.search.value.trim().toLowerCase();
            const status = els.statusFilter.value;
            const from = els.fromDate.value ? new Date(els.fromDate.value) : null;
            const to = els.toDate.value ? new Date(els.toDate.value) : null;

            filteredData = data.filter(item => {
                // Global search
                if (searchTerm && !Object.values(item).join(' ').toLowerCase().includes(searchTerm)) return false;

                // Status filter
                if (status && item.status !== status) return false;

                // Date range
                const itemDate = toBDT(item.lastUpdate);
                if (from && itemDate < from) return false;
                if (to) { to.setHours(23, 59, 59, 999); }
                if (to && itemDate > to) return false;

                // Column filters (select & input)
                for (const select of els.filterSelects) {
                    if (select.value && item[select.dataset.col] !== select.value) return false;
                }
                for (const input of els.filterInputs) {
                    const term = input.value.trim().toLowerCase();
                    if (term && !String(item[input.dataset.col] || '').toLowerCase().includes(term)) return false;
                }

                return true;
            });

            currentPage = 1;
            renderTable();
        }

        // Debounce rapid inputs
        function debounceFilter() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(applyFilters, DEBOUNCE_DELAY);
        }

        // ========================================
        // RENDER TABLE & PAGINATION
        // ========================================
        function renderTable() {
            const start = (currentPage - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const pageData = filteredData.slice(start, end);

            // Render rows
            els.body.innerHTML = pageData.length
                ? pageData.map(createRow).join('')
                : '<tr><td colspan="10" class="text-center text-muted py-3">No entries found</td></tr>';

            // Update pagination info
            els.showRange.textContent = filteredData.length ? `${start + 1}-${Math.min(end, filteredData.length)}` : '0-0';
            els.totalCount.textContent = filteredData.length;

            // Pagination controls
            const totalPages = Math.max(1, Math.ceil(filteredData.length / PAGE_SIZE));
            els.prevBtn.classList.toggle('disabled', currentPage === 1);
            els.nextBtn.classList.toggle('disabled', currentPage === totalPages);

            // Render page numbers
            els.pageNumbers.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const active = i === currentPage ? 'active' : '';
                els.pageNumbers.innerHTML += `<li class="page-item ${active}"><a class="page-link" href="#">${i}</a></li>`;
            }
            els.pageNumbers.querySelectorAll('a').forEach((link, idx) => {
                link.onclick = e => { e.preventDefault(); currentPage = idx + 1; renderTable(); };
            });
        }

        // ========================================
        // EXPORT: COLUMN PICKER
        // ========================================
        const columnDisplayNames = {
            serialNumber: "S/N", area: "AREA", location: "LOCATION", brand: "BRAND",
            model: "MODEL", itemType: "ITEM TYPE", quantity: "QTY", status: "STATUS",
            lastUpdate: "LAST UPDATE", username: "Logged By"
        };

        function buildColumnCheckboxes() {
            const columns = Object.keys(data[0] || {});
            columns.forEach(col => {
                const label = columnDisplayNames[col] || col;
                const html = `
                    <div class="col-6 col-md-4 col-lg-3 mb-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${col}" id="cb_${col}" checked>
                            <label class="form-check-label" for="cb_${col}">${label}</label>
                        </div>
                    </div>`;
                els.colCheckboxes.insertAdjacentHTML('beforeend', html);
            });
        }

        // Update file name preview
        function updateFileName() {
            const title = els.reportTitle.value.trim() || 'New Asset List';
            const today = new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' });
            els.fileName.textContent = `${title} (Date ${today}).xlsx`;
        }

        // ========================================
        // EXPORT: EXCEL GENERATION
        // ========================================
        els.confirmExport.addEventListener('click', async () => {
            if (filteredData.length === 0) return alert('No data to export');

            const selectedCols = Array.from(els.colCheckboxes.querySelectorAll('input:checked'))
                                      .map(cb => cb.value);
            if (selectedCols.length === 0) return alert('Select at least one column');

            const wb = new ExcelJS.Workbook();
            wb.creator = "Padma Bridge O&M";
            wb.created = new Date();

            // === Sheet 1: Summary by Location & Status ===
            const wsSummary = wb.addWorksheet("All Equipments Total Number");

            const areas = [...new Set(filteredData.map(r => r.area))].filter(Boolean);
            const summary = {};

            filteredData.forEach(item => {
                const type = item.itemType || 'Unknown';
                if (!summary[type]) {
                    summary[type] = { Total: 0, Damaged: 0, Standby: 0, Servicing: 0 };
                    areas.forEach(area => summary[type][area] = 0);
                }
                const qty = Number(item.quantity) || 0;
                summary[type].Total += qty;
                if (areas.includes(item.area)) summary[type][item.area] += qty;
                if (item.status === 'Damaged') summary[type].Damaged += qty;
                if (item.status === 'Standby') summary[type].Standby += qty;
                if (item.status === 'Servicing') summary[type].Servicing += qty;
            });

            // Header
            wsSummary.addRow(["Item Name", "Quantity", "Location", ...Array(9).fill("")]);
            const locHeader = wsSummary.addRow(["", "", ...areas, ...Array(9 - areas.length).fill(""), "Total", "Damaged", "Standby", "Servicing"]);
            locHeader.font = { bold: true };
            locHeader.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFCC' } };

            // Data rows
            Object.keys(summary).sort().forEach(type => {
                const row = [type, "", ...areas.map(a => summary[type][a] || 0),
                             ...Array(9 - areas.length).fill(0),
                             summary[type].Total, summary[type].Damaged, summary[type].Standby, summary[type].Servicing];
                wsSummary.addRow(row);
            });

            // Total row
            const totalQtyByArea = area => filteredData.filter(r => r.area === area).reduce((s, r) => s + (Number(r.quantity) || 0), 0);
            const totalDamaged = filteredData.filter(r => r.status === 'Damaged').reduce((s, r) => s + (Number(r.quantity) || 0), 0);
            const totalStandby = filteredData.filter(r => r.status === 'Standby').reduce((s, r) => s + (Number(r.quantity) || 0), 0);
            const totalServicing = filteredData.filter(r => r.status === 'Servicing').reduce((s, r) => s + (Number(r.quantity) || 0), 0);

            wsSummary.addRow(["Total Items", "",
                ...areas.map(totalQtyByArea), ...Array(9 - areas.length).fill(0),
                filteredData.reduce((s, r) => s + (Number(r.quantity) || 0), 0),
                totalDamaged, totalStandby, totalServicing
            ]);

            // Highlight Damaged & Standby
            const damagedCol = locHeader.values.indexOf('Damaged');
            const standbyCol = locHeader.values.indexOf('Standby');
            for (let r = 3; r <= wsSummary.rowCount; r++) {
                const damagedCell = wsSummary.getCell(r, damagedCol);
                const standbyCell = wsSummary.getCell(r, standbyCol);
                if (damagedCell.value > 0) damagedCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFCCCC' } };
                if (standbyCell.value > 0) standbyCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF99' } };
            }

            wsSummary.columns = [{ width: 25 }, { width: 10 }, ...Array(9).fill({ width: 12 }), { width: 10 }, { width: 10 }, { width: 10 }, { width: 10 }];

            // === Sheet 2: Individual Items ===
            const wsIndividual = wb.addWorksheet("Individual Items");
            const header = wsIndividual.addRow(selectedCols.map(col => columnDisplayNames[col] || col));
            header.font = { bold: true };

            filteredData.forEach(item => {
                wsIndividual.addRow(selectedCols.map(col => item[col] ?? ''));
            });

            wsIndividual.columns.forEach((col, i) => col.width = [6,12,20,15,18,20,6,12,12][i] || 15);

            // === Download File ===
            const buffer = await wb.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: "application/octet-stream" });
            saveAs(blob, els.fileName.textContent);
            els.modal.hide();

            // Success toast
            const toast = document.createElement('div');
            toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed top-0 end-0 m-3';
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        Exported <strong>${filteredData.length}</strong> assets!
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>`;
            document.body.appendChild(toast);
            new bootstrap.Toast(toast).show();
        });

        // ========================================
        // EVENT LISTENERS
        // ========================================
        els.search.oninput = () => {
            els.clearSearch.classList.toggle('d-none', !els.search.value);
            debounceFilter();
        };

        els.clearSearch.onclick = () => {
            els.search.value = '';
            els.clearSearch.classList.add('d-none');
            applyFilters();
        };

        [els.fromDate, els.toDate, els.statusFilter, ...els.filterSelects, ...els.filterInputs].forEach(el => {
            el.onchange = el.tagName === 'INPUT' ? debounceFilter : applyFilters;
        });

        els.prevBtn.onclick = e => { e.preventDefault(); if (currentPage > 1) { currentPage--; renderTable(); } };
        els.nextBtn.onclick = e => { e.preventDefault(); const max = Math.ceil(filteredData.length / PAGE_SIZE); if (currentPage < max) { currentPage++; renderTable(); } };

        // Modal events
        $('#exportModal').addEventListener('show.bs.modal', () => {
            buildColumnCheckboxes();
            updateFileName();
        });

        els.reportTitle.oninput = updateFileName;

        // Clear all filters
        window.clearFilters = () => {
            els.search.value = '';
            els.clearSearch.classList.add('d-none');
            els.fromDate.value = '';
            els.toDate.value = '';
            els.statusFilter.value = '';
            els.filterSelects.forEach(s => s.value = '');
            els.filterInputs.forEach(i => i.value = '');
            applyFilters();
        };















        const logModalEl = document.getElementById('logModal');
const logTimeline = $('#logTimeline');
const logEmpty    = $('#logEmpty');

logModalEl.addEventListener('show.bs.modal', async function (e) {
    const btn = e.relatedTarget;                 // the button that triggered
    const sn  = btn.dataset.sn;                  // serial number

    // reset UI
    logTimeline.innerHTML = '';
    logEmpty.classList.add('d-none');

    // show spinner
    logTimeline.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div></div>';

    try {
        const resp = await fetch(`/Entries/GetLog?sn=${encodeURIComponent(sn)}`);
        if (!resp.ok) throw new Error('Not found');
        const logs = await resp.json();          // expected: [{time, user, action, details}, …]

        if (!logs || logs.length === 0) {
            logEmpty.classList.remove('d-none');
            logTimeline.innerHTML = '';
            return;
        }

        // ---- render timeline ----
        const container = document.createElement('div');
        container.className = 'timeline';

        logs.forEach((log, idx) => {
            const badgeClass = idx === 0 ? 'bg-success' : 'bg-primary';
            const item = document.createElement('div');
            item.className = 'timeline-item';
            item.innerHTML = `
                <div class="d-flex">
                    <div class="timeline-badge ${badgeClass} rounded-circle d-flex align-items-center justify-content-center me-3">
                        ${idx + 1}
                    </div>
                    <div class="flex-grow-1 bg-light rounded-3 p-3 shadow-sm">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <strong class="text-primary">${log.action}</strong>
                            <small class="text-muted">${log.time}</small>
                        </div>
                        <div class="text-dark"><strong>User:</strong> ${log.user}</div>
                      
                    </div>
                </div>`;
            container.appendChild(item);
        });

        logTimeline.innerHTML = '';
        logTimeline.appendChild(container);

    } catch (err) {
        logTimeline.innerHTML = `<div class="text-danger text-center py-3">Failed to load log.</div>`;
        console.error(err);
    }
});














        // ========================================
        // INITIALIZE
        // ========================================
        setTimeout(applyFilters, 50);
    </script>



    <style>
        #logTimeline .timeline { position:relative; padding-left:2rem; }
#logTimeline .timeline::before{
    content:''; position:absolute; left:18px; top:0; bottom:0;
    width:2px; background:#dee2e6;
}
#logTimeline .timeline-item { position:relative; margin-bottom:1rem; }
#logTimeline .timeline-badge{
    position:absolute; left:-38px; top:0; z-index:1;
    width:36px; height:36px; display:flex;
    align-items:center; justify-content:center;
    font-size:.9rem; color:#fff; border-radius:50%;
}
    </style>



}