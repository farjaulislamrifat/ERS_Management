@model IEnumerable<ERS_Management.Models.FaultEntry>
@{
    ViewData["Title"] = "Fault Entries";
    var faults = Model.ToList();

    // Unique values for dropdowns
    var sites = faults.Select(f => f.Site).Where(s => s != null).Distinct().OrderBy(s => s).ToList();
    var categories = faults.Select(f => f.Category).Where(c => c != null).Distinct().OrderBy(c => c).ToList();
    var reporters = faults.Select(f => f.ReportedBy).Where(r => r != null).Distinct().OrderBy(r => r).ToList();
    var locations = faults.Select(f => f.Location).Where(l => l != null).Distinct().OrderBy(l => l).ToList();
    var resolvedBy = faults.Select(f => f.ResolvedBy).Where(l => l != null).Distinct().OrderBy(l => l).ToList();

    const int PageSize = 10;
}

<div class="container-fluid py-4">
    <!-- Header -->
 <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-4">
        <h2 class="h3 mb-0 text-dark fw-bold">Fault Entries</h2>
        <div class="d-flex gap-2">
            <button id="exportExcel" class="btn btn-success btn-sm shadow-sm" data-bs-toggle="modal" data-bs-target="#exportModal">
                <i class="bi bi-file-earmark-excel me-1"></i> Export to Excel
            </button>
            <a asp-controller="FaultEntries" asp-action="Create" class="btn btn-primary shadow-sm">
                <i class="bi bi-plus-circle"></i> Create New
            </a>
        </div>
    </div>

    <!-- Filters Card -->
<!-- Filters Card -->
<div class="card border-0 shadow-sm mb-4 rounded-4 overflow-hidden">
    <div class="card-body p-4">
        <div class="row g-3 align-items-center">

      <!-- Global Search (Ultra Modern) -->
<div class="col-12 col-md-6 col-lg-5">
    <label for="globalSearch" class="visually-hidden">Search all columns</label>
    
    <div class="position-relative">
        <!-- Glassmorphic Input Group -->
        <div class="input-group input-group-merge border-0 shadow-lg rounded-4 overflow-hidden"
             style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);">
             
            <!-- Search Icon (Animated on Focus) -->
            <span class="input-group-text bg-transparent border-0 text-primary px-3 transition-all">
                <i class="bi bi-search fs-5"></i>
            </span>

            <!-- Floating Placeholder + Smooth Input -->
            <input
                type="text"
                id="globalSearch"
                class="form-control form-control-lg border-0 bg-transparent text-dark fw-medium shadow-0"
                placeholder="Search anything..."
                aria-label="Global search"
                autocomplete="off"
                style="font-size: 0.975rem; outline: none !important;">
        </div>

        <!-- Optional: Clear Button (Appears on Input) -->
        <button 
            type="button" 
            class="btn btn-sm position-absolute end-0 top-50 translate-middle-y me-2 d-none"
            id="clearSearch"
            onclick="document.getElementById('globalSearch').value=''; this.classList.add('d-none');"
            style="z-index: 10;">
            <i class="bi bi-x-circle-fill text-muted"></i>
        </button>
    </div>
</div>
       <!-- Date Range (Inline Labels + Inputs) -->
<div class="col-12 col-md-6 col-lg-4">
    <div class="d-flex flex-column flex-md-row gap-3 align-items-start align-items-md-center">

        <!-- From Date: Label + Input Inline -->
        <div class="d-flex align-items-center gap-2 flex-fill" style="min-width: 140px;">
            <label for="fromDate" class="text-muted small fw-medium text-nowrap mb-0">
                From
            </label>
            <input
                type="date"
                id="fromDate"
                class="form-control form-control-sm rounded-3 border-0 shadow-sm flex-fill"
                title="From date (BDT)"
                aria-label="From date">
        </div>

        <!-- To Date: Label + Input Inline -->
        <div class="d-flex align-items-center gap-2 flex-fill" style="min-width: 140px;">
            <label for="toDate" class="text-muted small fw-medium text-nowrap mb-0">
                To
            </label>
            <input
                type="date"
                id="toDate"
                class="form-control form-control-sm rounded-3 border-0 shadow-sm flex-fill"
                title="To date (BDT)"
                aria-label="To date">
        </div>

    </div>
</div>

         
          
        </div>
    </div>
</div>

    <!-- Table Card -->
    <div class="card border-0 shadow-sm overflow-hidden">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="faultsTable">
                    <thead class="bg-light text-dark small text-uppercase sticky-top">
                        <tr>
                          <th class="ps-4">No</th>
                    <th>Fault Time (BDT)</th>
                    <th>Reported By</th>
                    <th>Site</th>
                    <th>Location</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Resolution</th>
                    <th>Resolved By</th>
                    <th>Remarks</th>
                    <th class="text-center">Duration</th>
                    <th class="text-end pe-4">Actions</th>
                        </tr>
                    </thead>

                    <!-- Filter Row -->
                    <thead class="bg-white border-bottom">
                        <tr class="filter-row">
                            <th class="ps-4"></th>
                            <th></th>
                            <th>
                                <select class="form-select form-select-sm filter-select" data-col="reportedBy">
                                    <option value="">All</option>
                                    @foreach (var r in reporters)
                                    {
                                        <option value="@r">@r</option>
                                    }
                                </select>
                            </th>
                            <th>
                                <select class="form-select form-select-sm filter-select" data-col="site">
                                    <option value="">All</option>
                                    @foreach (var s in sites)
                                    {
                                        <option value="@s">@s</option>
                                    }
                                </select>
                            </th>
                            <th>
                                <select class="form-select form-select-sm filter-select" data-col="location">
                                    <option value="">All</option>
                                    @foreach (var l in locations)
                                    {
                                        <option value="@l">@l</option>
                                    }
                                </select>
                            </th>
                            <th>
                                <input type="text" class="form-control form-control-sm" placeholder="Desc…" data-col="description">
                            </th>
                            <th>
                                <select class="form-select form-select-sm filter-select" data-col="category">
                                    <option value="">All</option>
                                    @foreach (var c in categories)
                                    {
                                        <option value="@c">@c</option>
                                    }
                                </select>
                            </th>
                            <th>

                                <input type="text" class="form-control form-control-sm" placeholder="Resolution" data-col="resolution">
 
                 
                            </th>
                            <th>
                                 <select class="form-select form-select-sm filter-select" data-col="resolvedBy">
                                    <option value="">All</option>
                                    @foreach (var c in  resolvedBy)
                                    {
                                        <option value="@c">@c</option>
                                    }
                                </select>
                            </th>
                            <th></th>
                            <th>
                                <input type="text" class="form-control form-control-sm" placeholder="h" data-col="duration">
                            </th>
                            <th class="text-end pe-4"></th>
                        </tr>
                    </thead>

                    <tbody id="tableBody" class="text-secondary">
                        <!-- Loading -->
                        <tr id="loadingRow">
                            <td colspan="10" class="text-center py-4">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span class="ms-2 text-muted">Loading entries...</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="card-footer bg-white border-top-0 py-3">
                <nav aria-label="Pagination" class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <ul class="pagination mb-0">
                        <li class="page-item" id="prevBtn"><a class="page-link" href="#" tabindex="-1">Previous</a></li>
                        <div id="pageNumbers" class="d-flex mx-2"></div>
                        <li class="page-item" id="nextBtn"><a class="page-link" href="#">Next</a></li>
                    </ul>
                    <small class="text-muted">
                        Showing <span id="showStart">0</span>–<span id="showEnd">0</span> of <span id="filteredCount">0</span>
                    </small>
                </nav>
            </div>
        </div>
    </div>
</div>






<!-- ====================== EXPORT MODAL ====================== -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content shadow-lg rounded-4">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="exportModalLabel">
                    <i class="bi bi-file-earmark-excel me-2"></i>Export Faults to Excel
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <form id="exportForm">
                    <!-- Report Title -->
                    <div class="mb-3">
                        <label for="reportTitle" class="form-label fw-semibold">Report Title (optional)</label>
                        <input type="text" class="form-control" id="reportTitle"
                               placeholder="e.g. Monthly Fault Report – Oct 2025">
                    </div>

                    <!-- Column selector -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Columns to export</label>
                        <div class="row row-cols-2 row-cols-md-3 g-2">
                            @foreach (var col in new[] {
                                new {id="colno",        label="No"},
                                new {id="colfaultTime", label="Fault Time"},
                                new {id="colreportedBy",label="Reported By"},
                                new {id="colsite",      label="Site"},
                                new {id="collocation",  label="Location"},
                                new {id="coldescription",label="Description"},
                                new {id="colcategory",  label="Category"},
                                new {id="colresolution",  label="Resolution"},
                                new {id="colresolvedBy",  label="Resolved by"},
                                new {id="colresolvedTime",  label="Time & date"},
                                new {id="colremarks",    label="Remarks"},
                                new {id="colduration",  label="Duration"}
                            })
                            {
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox"
                                               id="@col.id" checked data-col="@col.id.Replace("col","")">
                                        <label class="form-check-label" for="@col.id">@col.label</label>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- File name preview -->
                    <div class="alert alert-info small py-2" id="fileNamePreview">
                        <strong>File name:</strong> <span id="previewName">Faults_Report_2025-11-14.xlsx</span>
                    </div>
                </form>
            </div>

            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmExport">
                    <i class="bi bi-download me-1"></i>Export
                </button>
            </div>
        </div>
    </div>
</div>




<!-- ====================== LOGS MODAL ====================== -->
<div class="modal fade" id="logsModal" tabindex="-1" aria-labelledby="logsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content rounded-4 shadow-lg">
            <div class="modal-header bg-gradient-info text-white">
                <h5 class="modal-title" id="logsModalLabel">
                    <i class="bi bi-journal-text me-2"></i> Fault #<span id="logFaultNo"></span> – Activity Log
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0" id="logsBody">
                <div class="text-center py-5">
                    <div class="spinner-border text-info" role="status">
                        <span class="visually-hidden">Loading logs...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
    // ============================= CONFIG =============================
    const PAGE_SIZE = @PageSize;
    const TIMEZONE_OFFSET_MINUTES = 6 * 60; // BDT = UTC+6
    const DEBOUNCE_DELAY = 300;

    // ============================= DOM ELEMENTS =============================
    const els = {
        tableBody: document.getElementById('tableBody'),
        loadingRow: document.getElementById('loadingRow'),
        globalSearch: document.getElementById('globalSearch'),
   
        fromDate: document.getElementById('fromDate'),
        toDate: document.getElementById('toDate'),
        filterSelects: document.querySelectorAll('.filter-select'),
        filterInputs: document.querySelectorAll('.filter-row input[data-col]'),
        prevBtn: document.getElementById('prevBtn'),
        nextBtn: document.getElementById('nextBtn'),
        pageNumbers: document.getElementById('pageNumbers'),
        showStart: document.getElementById('showStart'),
        showEnd: document.getElementById('showEnd'),
        filteredCount: document.getElementById('filteredCount'),
        totalCount: document.getElementById('totalCount'),
      exportBtn: document.getElementById('exportExcel'),
        modal: new bootstrap.Modal(document.getElementById('exportModal')),
        confirmExport: document.getElementById('confirmExport'),
        reportTitle: document.getElementById('reportTitle'),
        fileNamePreview: document.getElementById('previewName'),
        columnCheckboxes: document.querySelectorAll('#exportModal input[type=checkbox]')
    };


    function clearFilters() {
    document.getElementById('globalSearch').value = '';
    document.getElementById('fromDate').value = '';
    document.getElementById('toDate').value = '';
    
    refreshTable();
}



    // ============================= USER INFO =============================
    const currentUser = "@User.Identity.Name".replace(/&quot;/g, '"');
    const isAdmin = @(User.IsInRole("Admin") ? "true" : "false");

    // ============================= DATA =============================
const allData = @Html.Raw(Json.Serialize(faults.Select(f => new {
        no = f.No,
        faultTime = f.FaultTime?.ToString("o"),
        resolvedTime = f.ResolvedTime?.ToString("o"),
        reportedBy = f.ReportedBy ?? "",
        site = f.Site ?? "",
        location = f.Location ?? "",
        description = f.Description ?? "",
        category = f.Category ?? "",
                resolution = f.Resolution,
           resolvedBy = f.ResolvedBy,
                remarks = f.Remarks,
        duration = f.Duration,
             
                username = f.Username
    })));

    console.log(allData);

    let filteredRows = [];
    let currentPage = 1;
    let debounceTimer;

    // ============================= HELPERS =============================
    const toBDT = (isoString) => {
        if (!isoString) return null;
        const d = new Date(isoString);
        const utc = d.getTime() + d.getTimezoneOffset() * 60000;
        return new Date(utc + TIMEZONE_OFFSET_MINUTES * 60000);
    };


    const getDuration = item => {
    if (item.duration != null) return item.duration;
    if (!item.faultTime || !item.resolvedTime) return null;
    return (new Date(item.resolvedTime) - new Date(item.faultTime)) / (1000 * 60 * 60);
};


const renderRow = item => {
    const dur = getDuration(item);
    const descEsc = item.description.replace(/"/g, '&quot;');
    
    const canEdit = item.username == currentUser ? true : false;
    const canDelete =isAdmin ;


    return `
<tr class="fault-row">
    <td class="ps-4 fw-semibold">#${item.no}</td>
    <td><small class="text-muted d-block">BDT</small>${formatBDT(item.faultTime)}</td>
    <td class="text-primary fw-medium">${item.reportedBy}</td>
    <td><span class="badge bg-light border text-dark px-3 py-2">${item.site}</span></td>
    <td>${item.location}</td>
    <td>
        <div class="text-truncate" style="max-width:200px;" title="${descEsc}">
            ${item.description}
        </div>
    </td>
    <td><span class="badge bg-info-subtle text-info-emphasis px-3 py-2">${item.category}</span></td>
    <td class="text-truncate" style="max-width:180px;" title="${item.resolution.replace(/"/g,'&quot;')}">
        ${item.resolution || '<span class="text-muted">—</span>'}
    </td>
    <td>${item.resolvedBy || '<span class="text-muted">—</span>'}</td>
    <td class="text-truncate" style="max-width:180px;" title="${item.remarks.replace(/"/g,'&quot;')}">
        ${item.remarks || '<span class="text-muted">—</span>'}
    </td>
    <td class="text-center">
        ${dur !== null
            ? `<span class="fw-medium">${dur.toFixed(1)} h</span>`
            : `<span class="text-muted">—</span>`
        }
    </td>
    <td class="text-end pe-4">
        <div class="btn-group btn-group-sm" role="group">
            <a href="/FaultEntries/Details/${item.no}" class="btn btn-outline-primary" title="View Details">Details</a>
            <button type="button" class="btn btn-outline-info" 
                data-bs-toggle="modal" data-bs-target="#logsModal"
                data-no="${item.no}" onclick="openLogsModal(${item.no})">
              Logs
        </button>
            ${canEdit   ? `<a href="/FaultEntries/Edit/${item.no}"   class="btn btn-outline-secondary" title="Edit">Edit</a>`   : ''}
            ${canDelete ? `<a href="/FaultEntries/Delete/${item.no}" class="btn btn-outline-danger"    title="Delete">Delete</a>` : ''}
        </div>
    </td>
</tr>`;
};
    // ============================= FILTERING =============================
    const applyFilters = () => {
        const global = els.globalSearch.value.trim().toLowerCase();
     
        const from = els.fromDate.value ? new Date(els.fromDate.value) : null;
        const to = els.toDate.value ? new Date(els.toDate.value) : null;

        filteredRows = allData.filter(item => {
            // Global search
            if (global) {
                const text = Object.values(item).join(' ').toLowerCase();
                if (!text.includes(global)) return false;
            }

         
            // Date range
            const faultDate = toBDT(item.faultTime);
            if (from && faultDate < from) return false;
            if (to) { to.setHours(23, 59, 59, 999); }
            if (to && faultDate > to) return false;

            // Column filters
            let match = true;

            els.filterSelects.forEach(sel => {
                if (!match || !sel.value) return;
                const col = sel.dataset.col;
                const val = item[col];
                if (val !== sel.value) match = false;
            });

            els.filterInputs.forEach(inp => {
                if (!match) return;
                const term = inp.value.trim().toLowerCase();
                if (!term) return;
                const col = inp.dataset.col;
                const val = (item[col] || '').toString().toLowerCase();
                if (!val.includes(term)) match = false;
            });

            return match;
        });

        currentPage = 1;
        renderPage();
        renderPagination();
    };

    const debounceFilter = () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(applyFilters, DEBOUNCE_DELAY);
    };

    // ============================= RENDERING =============================
    const renderPage = () => {
        els.loadingRow.style.display = filteredRows.length === 0 ? 'table-row' : 'none';
        const start = (currentPage - 1) * PAGE_SIZE;
        const end = start + PAGE_SIZE;
        const pageData = filteredRows.slice(start, end);

        els.tableBody.innerHTML = pageData.length
            ? pageData.map(renderRow).join('')
            : '<tr><td colspan="10" class="text-center text-muted py-4">No entries found.</td></tr>';

        els.showStart.textContent = filteredRows.length === 0 ? 0 : start + 1;
        els.showEnd.textContent = Math.min(end, filteredRows.length);
        els.filteredCount.textContent = filteredRows.length;
    };

    const renderPagination = () => {
        const totalPages = Math.max(1, Math.ceil(filteredRows.length / PAGE_SIZE));
        els.pageNumbers.innerHTML = '';

        els.prevBtn.classList.toggle('disabled', currentPage === 1);
        els.nextBtn.classList.toggle('disabled', currentPage === totalPages);

        const maxButtons = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);
        if (endPage - startPage + 1 < maxButtons) {
            startPage = Math.max(1, endPage - maxButtons + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = 'page-item';
            li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            if (i === currentPage) li.classList.add('active');
            li.addEventListener('click', e => {
                e.preventDefault();
                currentPage = i;
                renderPage();
                renderPagination();
            });
            els.pageNumbers.appendChild(li);
        }
    };


    document.getElementById('globalSearch').autocomplete = 'off';

const searchInput = document.getElementById('globalSearch');
const clearBtn = document.getElementById('clearSearch');

searchInput.addEventListener('input', function () {
    clearBtn.classList.toggle('d-none', this.value === '');
});

// Optional: Focus animation
searchInput.addEventListener('focus', function () {
  
    this.parentElement.parentElement.querySelector('.input-group-text').innerHTML = '<i class="bi bi-search fs-5 text-primary"></i>';
});

searchInput.addEventListener('blur', function () {
   
});

const generateFileName = () => {
        const today = new Date().toISOString().slice(0,10);
        const title = els.reportTitle.value.trim();
        const base = title ? title.replace(/[^a-z0-9]/gi,'_') : 'Faults_Report';
        return `${base}_${today}.xlsx`;
    };

    const updatePreview = () => {
        els.fileNamePreview.textContent = generateFileName();
    };

   

    els.confirmExport.addEventListener('click', async () => {
    if (filteredRows.length === 0) {
        alert('No data to export.');
        return;
    }

    // ---- Selected Columns ----
    const selectedCols = Array.from(els.columnCheckboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.dataset.col);

    const headerMap = {
        no: 'No', faultTime: 'Fault Time (BDT)', reportedBy: 'Reported By',
        site: 'Site', location: 'Location', description: 'Description',
        category: 'Category', status: 'Status', duration: 'Duration (h)', resolution:"Resolution", remarks: "Remarks"
    };
    const headerRow = selectedCols.map(c => headerMap[c]);

    // ---- Build data rows with formatting ----
    const dataRows = filteredRows.map(item => selectedCols.map(col => {
        if (col === 'no') return `#${item.no}`;
        if (col === 'faultTime') return formatBDT(item.faultTime);
        if (col === 'resolvedTime') return formatBDT(item.resolvedTime);
        if (col === 'duration') return item.duration ? (item.duration.toFixed(1) + 'H') : '';
        return item[col] ?? '';
    }));

    // ---- Convert to object array for ExcelJS ----
    const exportData = dataRows.map(row => {
        const obj = {};
        selectedCols.forEach((col, i) => {
            obj[col] = row[i];
        });
        return obj;
    });

    // ---- Generate Excel with both sheets ----
    await generateFaultReportExcel(exportData, filteredRows); // pass full rows for Report sheet
});

function formatBDT(input) {
  let date;

  // 1. Excel serial number
  if (typeof input === 'number' && !isNaN(input)) {
    const excelEpoch = Date.UTC(1899, 11, 30);           // 1899-12-30 00:00 UTC
    const ms = input * 86400000;                        // days → ms
    const bdtMs = ms + 6 * 3600000;                     // BDT = UTC+6
    date = new Date(excelEpoch + bdtMs);
  } 
  // 2. ISO string (e.g. "2025-06-01T10:15:00.0000000")
  else if (typeof input === 'string') {
    // Parse ISO string safely (handles 7-digit micros)
    const cleaned = input.replace(/\d{7}$/, match => match.slice(0, 3)); // keep only ms
    date = new Date(cleaned + 'Z'); // assume UTC
    date.setHours(date.getUTCHours() + 6); // convert to BDT
  } 
  // 3. Date object
  else if (input instanceof Date) {
    date = new Date(input);
    date.setHours(date.getUTCHours() + 6);
  } 
  else {
    return '';
  }

  const pad = n => String(n).padStart(2, '0');
  return `${date.getUTCFullYear()}-${pad(date.getUTCMonth() + 1)}-${pad(date.getUTCDate())} ` +
         `${pad(date.getUTCHours())}:${pad(date.getUTCMinutes())}`;
}

// === 5. FULL EXCEL GENERATOR (Merged) ===
async function generateFaultReportExcel(selectedData, fullData, filename = "ITS_Fault_Report_October_2025.xlsx") {
    const workbook = new ExcelJS.Workbook();
    workbook.creator = "ITS Fault Reporter";
    workbook.created = new Date();

    // -------------------------------------------------
    // SHEET 1: Work Pad To Report (Selected Columns Only)
    // -------------------------------------------------
    const sheet1 = workbook.addWorksheet("Work Pad To Report");
    sheet1.addRow(["", "Fault Report For The Month of October-2025", "", "", "", "", "", "", "", "", ""]);
    sheet1.addRow(["", "", "", "", "", "", "", "", "", "", "Ver 1.1"]);
    sheet1.addRow(["", "Fault Found", "", "", "", "", "Resolution", "", "", "", "Remarks"]);
    
    // Dynamic header from selected columns
    const headerCells = selectedData.length > 0 ? Object.keys(selectedData[0]) : [];
    const headerRow1 = sheet1.addRow(["", ...headerCells.map(() => "")]);
 // placeholder

    // Actually add the selected header
    const finalHeader = sheet1.addRow(["", ...headerCells]);
    finalHeader.font = { bold: true };
    finalHeader.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFFF00" } };

    // Add data
    selectedData.forEach(row => {
        sheet1.addRow(["", ...Object.values(row)]);
    });

    // Column widths
    sheet1.columns.forEach((col, i) => {
        col.width = i === 0 ? 5 : [18, 20, 20, 15, 18, 40, 12, 18, 15][i-1] || 18;
    });

    // -------------------------------------------------
    // SHEET 2: Report (Dynamic Summary from FULL data)
    // -------------------------------------------------
    const sheet2 = workbook.addWorksheet("Report");
    const addSpacer = (n = 1) => { for (let i = 0; i < n; i++) sheet2.addRow([]); };

    // A) Category Wise
    const categories = [...new Set(fullData.map(r => r.category))].filter(Boolean);
    const catCounts = {};
    fullData.forEach(r => { catCounts[r.category] = (catCounts[r.category] || 0) + 1; });

    sheet2.addRow(["A) Category wise Fault"]);
    sheet2.addRow(["No", "Items/Category", "Total Fault Case", "Fault Case this month", "remarks", "Previous Data"]);
    let catNo = 1;
    categories.forEach(cat => sheet2.addRow([catNo++, cat, catCounts[cat], "", "", ""]));
    sheet2.addRow(["Total", "", fullData.length, "", "", ""]);
    addSpacer(3);

    // B) Site Wise
    const sites = [...new Set(fullData.map(r => r.site))].filter(Boolean);
    const siteCounts = {};
    fullData.forEach(r => { siteCounts[r.site] = (siteCounts[r.site] || 0) + 1; });

    sheet2.addRow(["B) Fault case per Site"]);
    sheet2.addRow(["No", "Site", "Fault Case", "Previous Data"]);
    let siteNo = 1;
    sites.forEach(site => sheet2.addRow([siteNo++, site, siteCounts[site], ""]));
    sheet2.addRow(["Total", "", fullData.length, ""]);
    addSpacer(3);

    // C) Location Wise
    const locations = [...new Set(fullData.map(r => r.location))].filter(Boolean);
    const locCounts = {};
    fullData.forEach(r => { if (r.location) locCounts[r.location] = (locCounts[r.location] || 0) + 1; });

    sheet2.addRow(["C) Location wise Fault"]);
    sheet2.addRow(["No", "Location", "Incident"]);
    let locNo = 1;
    locations.forEach(loc => sheet2.addRow([locNo++, loc, locCounts[loc]]));
    const totalIncidents = Object.values(locCounts).reduce((a, b) => a + b, 0);
    sheet2.addRow(["", "Total Incident=", totalIncidents]);

    // Style headers
    [1, 8, 14].forEach(n => {
        const row = sheet2.getRow(n);
        row.font = { bold: true };
        row.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFCC' } };
    });
    sheet2.columns.forEach((col, i) => col.width = [6, 25, 18, 20, 15, 18][i] || 15);

    // -------------------------------------------------
    // EXPORT
    // -------------------------------------------------
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: "application/octet-stream" });
    saveAs(blob, filename);



     els.modal.hide();
    
    // Success feedback
    const toast = new bootstrap.Toast(document.createElement('div'));
    const toastEl = document.createElement('div');
    toastEl.className = 'toast align-items-center text-white bg-success border-0 position-fixed top-0 end-0 m-3';
    toastEl.setAttribute('role', 'alert');
    toastEl.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-check-circle-fill me-2"></i>
                Exported <strong>${filteredRows.length}</strong> records to Excel!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    document.body.appendChild(toastEl);
    toast._element = toastEl;
    toast.show();



}









// ============================= LOGS MODAL =============================
const logsModalEl = document.getElementById('logsModal');
const logFaultNo = document.getElementById('logFaultNo');
const logsBody = document.getElementById('logsBody');

let logsModal;

document.addEventListener('DOMContentLoaded', () => {
    logsModal = new bootstrap.Modal(logsModalEl);
});

async function openLogsModal(faultNo) {
    logFaultNo.textContent = faultNo;
    logsBody.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-info" role="status">
                <span class="visually-hidden">Loading logs...</span>
            </div>
        </div>`;

    logsModal.show();

    try {
        const resp = await fetch(`/FaultEntries/GetLog?no=${encodeURIComponent(faultNo)}`);
        if (!resp.ok) throw new Error('Failed to load logs');

        const logs = await resp.json();

        if (!logs || logs.length === 0) {
            logsBody.innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="bi bi-inbox fs-1"></i><br>
                    <small>No activity logs found.</small>
                </div>`;
            return;
        }

        // Render timeline
        const timeline = document.createElement('div');
        timeline.className = 'timeline p-3';

        logs.forEach((log, idx) => {
            const badgeClass = idx === 0 ? 'bg-success' : 'bg-primary';
            const item = document.createElement('div');
            item.className = 'timeline-item';
            item.innerHTML = `
                <div class="d-flex">
                    <div class="timeline-badge ${badgeClass} rounded-circle d-flex align-items-center justify-content-center me-3">
                        ${idx + 1}
                    </div>
                    <div class="flex-grow-1 bg-light rounded-3 p-3 shadow-sm">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <strong class="text-primary">${escapeHtml(log.action)}</strong>
                            <small class="text-muted">${log.time}</small>
                        </div>
                        <div class="text-dark"><strong>User:</strong> ${escapeHtml(log.user)}</div>
                     
                    </div>
                </div>`;
            timeline.appendChild(item);
        });

        logsBody.innerHTML = '';
        logsBody.appendChild(timeline);

    } catch (err) {
        logsBody.innerHTML = `
            <div class="text-danger text-center py-4">
                <i class="bi bi-exclamation-triangle"></i><br>
                Failed to load logs.
            </div>`;
        console.error(err);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}












    // ============================= EVENT LISTENERS =============================
    els.globalSearch.addEventListener('input', debounceFilter);

    els.fromDate.addEventListener('change', applyFilters);
    els.toDate.addEventListener('change', applyFilters);
    els.filterSelects.forEach(s => s.addEventListener('change', applyFilters));
    els.filterInputs.forEach(i => i.addEventListener('input', debounceFilter));

    els.prevBtn.addEventListener('click', e => {
        e.preventDefault();
        if (currentPage > 1) { currentPage--; renderPage(); renderPagination(); }
    });
    els.nextBtn.addEventListener('click', e => {
        e.preventDefault();
        const total = Math.ceil(filteredRows.length / PAGE_SIZE);
        if (currentPage < total) { currentPage++; renderPage(); renderPagination(); }
    });


    document.getElementById('exportModal').addEventListener('show.bs.modal', updatePreview);
    els.reportTitle.addEventListener('input', updatePreview);



    // ---- (All previous listeners – filters, pagination, etc.) ----
    // ... (copy-paste your existing listeners here) ...

    // Initial render
    setTimeout(() => {
        applyFilters();
        els.loadingRow.style.display = 'none';
    }, 100);

    // Initial render
    setTimeout(() => {
        applyFilters();
        els.loadingRow.style.display = 'none';
    }, 100);
</script>


<style>
    #logsBody .timeline {
    position: relative;
    padding-left: 2.5rem;
}
#logsBody .timeline::before {
    content: '';
    position: absolute;
    left: 18px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}
#logsBody .timeline-item {
    position: relative;
    margin-bottom: 1.25rem;
}
#logsBody .timeline-badge {
    position: absolute;
    left: -38px;
    top: 0;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    color: white;
    z-index: 1;
}
</style>






}